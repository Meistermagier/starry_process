% !TeX root = ./ms.tex
\documentclass[modern]{aastex62}

% Load the corTeX style definitions
\input{cortex}

% Load custom style
\input{style}

% Bibliography
\bibliographystyle{aasjournal}

\usepackage{etoolbox}
\makeatletter % we need to patch \env@cases that has @ in its name
\patchcmd{\env@cases}{\quad}{\qquad\qquad}{}{}
\makeatother

\usepackage{enumitem}

% Begin!
\begin{document}

% Title
\title{%
    \textbf{
        Interpretable Gaussian Processes for Stellar Light Curves
    }
}

% Author list
\author[0000-0002-0296-3826]{Rodrigo Luger}\altaffiliation{Flatiron Fellow}
\email{rluger@flatironinstitute.org}
\affil{Center~for~Computational~Astrophysics, Flatiron~Institute, New~York, NY}
\affil{Virtual~Planetary~Laboratory, University~of~Washington, Seattle, WA}
%

\keywords{methods: analytic}

% \begin{abstract}
%     Abstract here.
%     %
%     \href{https://github.com/rodluger/starry_process}{\color{linkcolor}\faGithub}
% \end{abstract}

\section{Introduction}
\label{sec:intro}
\xxx{Talk about starry, gps, and whatnot.}

\section{Spherical Harmonics}
\label{sec:ylm}
%
\xxx{Introduce the spherical harmonics.}

The real spherical harmonics are indexed by their degree $l \in [0, \infty]$
and order $m \in [-l, l]$. It is convenient to collect the spherical harmonic coefficients of
a given expansion into a vector $\mathbf{y}$ indexed by a single
integer $n$, where
%
\begin{align}
    \label{eq:n}
    n = l^2 + l + m
\end{align}
%
and, conversely,
%
\begin{align}
    \label{eq:lm}
    \begin{split}
        l & = \floor{\sqrt{n}}
        \\
        m & = n - l^2 - l
        \quad.
    \end{split}
\end{align}

\section{Gaussian Process}
\label{sec:gp}
%

% The vector $\pmb{\theta}$ includes physical properties of the star such
% as its inclination $i$ and rotational period $P$ as well as parameters
% describing the shape of the probability density function (PDF) governing
% the distribution of features on the surface.

Let
$\mathbf{f} = \left( f_0 \, f_1 \, \cdots \,  f_K \right)^\top$
denote a vector of $K$ flux measurements at times
$\left( t_0 \,  t_1 \,  \cdots \, t_K \right)^\top$.
Conditioned on certain physical properties of the star, $\pmb{\theta}$,
we wish to compute the mean $\pmb{\mu}(\pmb{\theta})$ and
covariance $\pmb{\Sigma}(\pmb{\theta})$
of $\mathbf{f}$, which together fully specify our GP in flux.
%
As with any random variable, the mean and covariance may be computed from
the expectation value of $\mathbf{f}$ and
$\mathbf{f}\,\mathbf{f}^\top$, respectively:
%
\begin{align}
    \label{eq:mean}
    \pmb{\mu}(\pmb{\theta})
     & = \mathrm{E} \Big[ \mathbf{f} \, \Big| \, \pmb{\theta} \Big]
    \\
    \label{eq:cov}
    \pmb{\Sigma}(\pmb{\theta})
     & = \mathrm{E} \Big[ \mathbf{f} \, \mathbf{f}^\top \, \Big| \, \pmb{\theta} \Big] - \pmb{\mu}^2(\pmb{\theta})
\end{align}
%
where the squaring operation in Equation~(\ref{eq:cov}) is
performed element-wise.
%
In \citet{Luger2019} we showed that $\mathbf{f}$ may be computed from a
linear operation on the vector of spherical harmonic coefficients
describing the surface, $\mathbf{y}$:
%
\begin{align}
    \label{eq:fAy}
    \mathbf{f} = \mathbf{A} \, \mathbf{y}
    \quad,
\end{align}
%
where $\mathbf{A}$ is the \starry design matrix, which is implicitly
a function of $\pmb{\theta}$ (as it depends on the stellar inclination
and rotation period, for example).
%
Given Equation~(\ref{eq:fAy}),
we may write the mean and covariance of our flux GP as
%
\begin{align}
    \pmb{\mu}(\pmb{\theta})
     & = \mathbf{A}(\pmb{\theta}) \, \pmb{\mu}_{\mathbf{y}}(\pmb{\theta})
    \\
    \pmb{\Sigma}(\pmb{\theta})
     & = \mathbf{A}(\pmb{\theta}) \, \pmb{\Sigma}_{\mathbf{y}} \, \mathbf{A}^\top(\pmb{\theta})
    \quad,
\end{align}
%
where
%
\begin{align}
    \label{eq:mean_y}
    \pmb{\mu}_{\mathbf{y}}(\pmb{\theta})
     & = \mathrm{E} \Big[ \mathbf{y} \, \Big| \, \pmb{\theta} \Big]
    \\
    \label{eq:cov_y}
    \pmb{\Sigma}_{\mathbf{y}}(\pmb{\theta})
     & = \mathrm{E} \Big[ \mathbf{y} \, \mathbf{y}^\top \, \Big| \, \pmb{\theta} \Big] - \pmb{\mu}_{\mathbf{y}}^2(\pmb{\theta})
\end{align}
%
are the mean and covariance of the GP in the spherical harmonics basis.
The bulk of the math in this paper is devoted to computing
the expectations in the expressions above, which
are given by the integrals
%
\begin{align}
    \label{eq:exp_y}
    \mathrm{E} \Big[ \mathbf{y} \, \Big| \, \pmb{\theta} \Big]
     & =
    \int \mathbf{y}(\mathbf{x} ) \, p(\mathbf{x} \, \big| \, \pmb{\theta})\mathrm{d}\mathbf{x}
    \\
    \label{eq:exp_yy}
    \mathrm{E} \Big[ \mathbf{y} \, \mathbf{y}^\top \, \Big| \, \pmb{\theta} \Big]
     & =
    \int \mathbf{y}(\mathbf{x} ) \mathbf{y}^\top(\mathbf{x} ) \, p(\mathbf{x} \, \big| \, \pmb{\theta})\mathrm{d}\mathbf{x}
    \quad,
\end{align}
%
where $\mathbf{x}$ is a random vector-valued variable corresponding to a particular
distribution of features on the surface  (i.e., the size and location of star spots)
and $p(\mathbf{x} \, \big| \, \pmb{\theta})$ is its probability density
function (PDF).

In the sections that follow we will show that for suitable choices of $\mathbf{y}(\mathbf{x})$
and $p(\mathbf{x} \, \big| \, \pmb{\theta})$, the integrals in the expressions
above have closed form solutions that may be evaluated quickly.
%
As we are specifically interested in modeling the effect of star spots
on stellar light curves, we let
%
\begin{align}
    \mathbf{x} = \left( \xi \,\, \lambda \,\, \phi \,\, \rho \right)^\top
\end{align}
%
and
%
\begin{align}
    \label{eq:RRs}
    \mathbf{y}(\mathbf{x}) =
    \xi
    \,
    \mathbf{R}_{\hat{\mathbf{y}}}(\lambda)
    \,
    \mathbf{R}_{\hat{\mathbf{x}}}(\phi)
    \,
    \mathbf{s}(\rho)
    \quad,
\end{align}
%
where $\xi$ is the contrast of a spot,
$\lambda$ is its longitude, $\phi$ is its latitude,
and $\rho$ is its radius.
The vector function $\mathbf{s}(\rho)$
returns the spherical harmonic expansion of a negative unit brightness
circular spot at $\lambda = \phi = 0$,
$\mathbf{R}_{\hat{\mathbf{x}}}(\phi)$ is the Wigner matrix that rotates the
expansion about $\hat{\mathbf{x}}$ such that the spot is centered at a
latitude $\phi$, and $\mathbf{R}_{\hat{\mathbf{y}}}(\lambda)$ is the Wigner
matrix that then rotates the
expansion about $\hat{\mathbf{y}}$ such that the spot is centered at a
longitude $\lambda$; these three functions are detailed in the sections below.
%
Equation~(\ref{eq:RRs}) thus provides a way of converting a random variable
$\mathbf{x}$ describing the size, brightness, and position of a spot to the
corresponding representation in terms of spherical harmonics.
%
Note, importantly, that we are not interested in any specific value of
$\mathbf{y}$; rather, we would like to know its expectation value under
the probability distribution governing the different spot properties $\mathbf{x}$,
i.e., $p(\mathbf{x} \, \big| \, \pmb{\theta})$.
%
For simplicity, we assume that $p(\mathbf{x} \, \big| \, \pmb{\theta})$
is separable in each of the four spot properties:
%
\begin{align}
    p(\mathbf{x} \, \big| \, \pmb{\theta})
    =
    p(\xi \, \big| \, \pmb{\theta}_{\xi}) \,
    p(\lambda \, \big| \, \pmb{\theta}_{\lambda}) \,
    p(\phi \, \big| \, \pmb{\theta}_{\phi})\,
    p(\rho \, \big| \, \pmb{\theta}_{\rho})
    \quad,
\end{align}
%
where
%
\begin{align}
    \pmb{\theta} = \left(
    \pmb{\theta}_{\xi} \, \,
    \pmb{\theta}_{\lambda} \, \,
    \pmb{\theta}_{\phi} \, \,
    \pmb{\theta}_{\rho} \right)^\top
    \quad.
\end{align}
%
This allows us to rewrite the expectation integrals (\ref{eq:exp_y})
and (\ref{eq:exp_yy}) as
%
\begin{align}
    \label{eq:exp_y_sep}
    \mathrm{E} \Big[ \mathbf{y} \, \Big| \, \pmb{\theta} \Big]
     & =
    \mathbf{e_4}(\pmb{\theta})
    \\[1em]
    \label{eq:exp_yy_sep}
    \mathrm{E} \Big[ \mathbf{y} \, \mathbf{y}^\top \, \Big| \, \pmb{\theta} \Big]
     & =
    \mathbf{E_4}(\pmb{\theta})
\end{align}
%
where we define the first moment integrals
%
\begin{align}
    \label{eq:e1}
    \mathbf{e_1}(\pmb{\theta}_\rho)
     & \equiv
    \int
    \mathbf{s}(\rho) \,
    p(\rho \, \big| \, \pmb{\theta}_{\rho}) \,
    \mathrm{d}\rho
    %
    \\[1em]
    %
    \label{eq:e2}
    \mathbf{e_2}(\pmb{\theta}_\phi, \mathbf{e_1})
     & \equiv
    \int
    \mathbf{R}_{\hat{\mathbf{x}}}(\phi) \,
    \mathbf{e_1} \,
    p(\phi \, \big| \, \pmb{\theta}_{\phi}) \,
    \mathrm{d}\phi
    %
    \\[1em]
    %
    \label{eq:e3}
    \mathbf{e_3}(\pmb{\theta}_\lambda, \mathbf{e_2})
     & \equiv
    \int
    \mathbf{R}_{\hat{\mathbf{y}}}(\lambda) \,
    \mathbf{e_2} \,
    p(\lambda \, \big| \, \pmb{\theta}_{\lambda}) \,
    \mathrm{d}\lambda
    \\[1em]
    \label{eq:e4}
    \mathbf{e_4}(\pmb{\theta}_\xi, \mathbf{e_3})
     & \equiv
    \int
    \xi \,
    \mathbf{e_3} \,
    p(\xi \, \big| \, \pmb{\theta}_{\xi}) \,
    \mathrm{d}\xi
    %
\end{align}
%
and the second moment integrals
%
\begin{align}
    \label{eq:E1}
    \mathbf{E_1}(\pmb{\theta}_\rho)
     & \equiv
    \int
    \mathbf{s}(\rho) \, \mathbf{s}^\top(\rho) \,
    p(\rho \, \big| \, \pmb{\theta}_{\rho}) \,
    \mathrm{d}\rho
    %
    \\[1em]
    %
    \label{eq:E2}
    \mathbf{E_2}(\pmb{\theta}_\phi, \mathbf{E_1})
     & \equiv
    \int
    \mathbf{R}_{\hat{\mathbf{x}}}(\phi) \,
    \mathbf{E_1} \,
    \mathbf{E_1}^\top \,
    \mathbf{R}_{\hat{\mathbf{x}}}^\top(\phi) \,
    p(\phi \, \big| \, \pmb{\theta}_{\phi})
    \mathrm{d}\phi
    %
    \\[1em]
    %
    \label{eq:E3}
    \mathbf{E_3}(\pmb{\theta}_\lambda, \mathbf{E_2})
     & \equiv
    \int
    \mathbf{R}_{\hat{\mathbf{y}}}(\lambda) \,
    \mathbf{E_2} \,
    \mathbf{E_2}^\top \,
    \mathbf{R}_{\hat{\mathbf{y}}}^\top(\lambda) \,
    p(\lambda \, \big| \, \pmb{\theta}_{\lambda})
    \mathrm{d}\phi
    \\[1em]
    %
    \label{eq:E4}
    \mathbf{E_4}(\pmb{\theta}_\xi, \mathbf{E_3})
     & \equiv
    \int
    \xi^2 \,
    \mathbf{E_3} \,
    \mathbf{E_3}^\top \,
    p(\xi \, \big| \, \pmb{\theta}_\xi)
    \mathrm{d}\xi
    %
    \quad.
\end{align}
%
We devote the next four sections to the computation of these eight
integrals.

%
\section{The Size Integrals: \lowercase{$\mathbf{e_1}$} and $\mathbf{E_1}$}
\label{sec:size}
%
\subsection{Functional form}
%
\xxx{TODO: Explain why we need the corrected, scaled radius.}

\subsubsection{$l_{\mathrm{max}} = \infty$}
\label{sec:size-function}
%
We adopt the following expression for the $n^{\mathrm{th}}$ term in $\mathbf{s}$
in the expansion of a dark, unit contrast circular spot at
$\lambda = \phi = 0$:
%
\begin{align}
    \label{eq:sinf}
    s_{n}'(\rho') =
    -\dfrac{1}{2\sqrt{2l + 1}}
    \begin{cases}
        \dfrac{\rho'}{1 + \rho'}
         & l = m = 0
        \\[1em]
        \dfrac{\rho' \left( 2 + \rho' \right)}
        {(1 + \rho')^{l + 1}}
         & l > 0, \, m = 0
        \\[1em]
        0
         & \mathrm{otherwise}
    \end{cases}
\end{align}
%
where
$l = l(n), m = m(n)$ (Equation~\ref{eq:lm}),
$\delta$ is the Kronecker delta,
$\rho' \in [0, \infty)$ is the spot radius,
and the prime superscript on both $s_{n}'$ and $\rho'$ denotes
the fact that this expression
is valid only in the limit $l_{\mathrm{max}} \rightarrow \infty$
(more on this below).
Equation~(\ref{eq:sinf}) is convenient because it satisfies
five important properties:
%
\begin{enumerate}[itemsep=2pt,parsep=1pt,label=\textbf{\arabic*}]
    \item The surface intensity is azimuthally symmetric about the spot center
    \item The surface intensity monotonically increases away from the spot center
    \item The surface intensity at the spot center is $-1$
    \item The surface intensity at the antipode of the spot center is zero
    \item The size of the spot increases monotonically with $\rho'$
\end{enumerate}
%
These properties may be demonstrated by considering the
expression for the surface intensity at a given polar angle $\theta$ and
azimuth $\varphi$:
%
\begin{align}
    \begin{split}
        I(\theta, \varphi)
        & =
        \sum\limits_{n=0}^\infty
        s_{n}' Y_{n}(\theta, \varphi) \\
        & =
        \sum\limits_{n=0}^\infty
        s_{n}' \sqrt{2l + 1} \delta_{m0} P_l(\cos\theta)
    \end{split}
\end{align}
%
where $Y_n$ is the spherical harmonic of degree $l(n)$ and order $m(n)$
(see Equation~\ref{eq:lm}),
$P_l$ is the Legendre polynomial of degree $l$,
and we have implicitly
assumed a normalization such that the integral of our expansion over
the unit sphere is $4\pi$.
Note that the expression above is independent of the azimuth $\varphi$,
a consequence of the fact that all harmonics with $m \ne 0$ are zero; this
expansion is therefore azimuthally symmetric about the spot center, as
stated in \textbf{1}.
%
Combining the above expression with Equation~(\ref{eq:sinf}) and
rearranging, we may write
%
\begin{align}
    \label{eq:Igen}
    I(\theta, \varphi) =
    I(\theta) =
    \dfrac{\rho'}{2}
    -
    \dfrac{\rho' \left( 2 + \rho' \right)}{2 (1 + \rho')}
    \sum\limits_{l=0}^\infty \left(\dfrac{1}{1 + \rho'}\right)^l P_l(\cos\theta)
    \quad.
\end{align}
%
The summation in Equation~(\ref{eq:Igen}) has a closed-form expression in
terms of the generating function of the Legendre polynomials:
%
\begin{align}
    \label{eq:gen}
    \sum\limits_{l=0}^\infty t^l P_l(\cos\theta) = \frac{1}{\sqrt{1 + t^2 - 2 t \cos\theta}}
    \quad,
\end{align}
%
so we may express the intensity as a function of polar angle
in the fairly simple form
%
\begin{align}
    \label{eq:Ifinal}
    I(\theta) & = A - \frac{B}{\sqrt{C - \cos\theta}}
    \quad,
    %
    \\
    \intertext{where}
    %
    \begin{split}
        A & = \dfrac{\rho'}{2}                      \\
        B & = \rho' (2 + \rho') \sqrt{\dfrac{1}{8 + 8 \rho'}} \\
        C & = \dfrac{1 + (1 + \rho')^2}{2 + 2 \rho'}
    \end{split}
\end{align}
%
are positive constants.

Differentiating Equation~(\ref{eq:Ifinal}) with respect to $\theta$, we have
%
\begin{align}
    \label{eq:Ideriv}
    \dfrac{\mathrm{d}I(\theta)}{\mathrm{d}\theta} & =
    -\frac{B\sin\theta}{2(C - \cos\theta)^\frac{3}{2}}
    \quad,
\end{align}
%
which is zero only for $\theta = 0$ (for which $I(\theta)$ is
minimized) and $\theta = \pi$ (for which it is maximized). The intensity
therefore increases monotonically from the spot center to the antipode,
as stated in \textbf{2}. The value at the minimum is
%
\begin{align}
    \begin{split}
        I_{\mathrm{min}} & = A - \dfrac{B}{\sqrt{C - 1}} \\
        & = -1
        \quad,
    \end{split}
\end{align}
%
as stated in \textbf{3}, and the value at the maximum is
%
\begin{align}
    \begin{split}
        I_{\mathrm{max}} & = A - \dfrac{B}{\sqrt{C + 1}} \\
        & = 0
        \quad,
    \end{split}
\end{align}
%
as stated in \textbf{4}.
Finally, to show \textbf{5}, let us compute the half width at half minimum
$\Delta\theta$ of the intensity profile:
%
\begin{align}
    A - \dfrac{B}{\sqrt{C - \cos{\Delta\theta}}} =
    -\dfrac{1}{2}
\end{align}
%
Solving for $\Delta\theta$ yields
%
\begin{align}
    \label{eq:hwhm}
    \Delta\theta(\rho') =
    \cos^{-1} \left[ \dfrac{2 + 3 \rho' (2 + \rho')}{2 (1 + \rho')^3} \right]
    \quad.
\end{align}
%
Differentiation with respect to $r$ yields
%
\begin{align}
    \dfrac{\mathrm{d}\Delta\theta}{\mathrm{d}\rho'} =
    \frac{3}{\left(1 + \rho'\right)
        \sqrt{\left(1 + 2 \rho'\right)
            \left(3 + 2 \rho'\right)}}
    \quad,
\end{align}
%
which is positive definite for all $\rho' > 0$.

For future reference, Equation~(\ref{eq:hwhm}) may be inverted to obtain the
radius $\rho'$ corresponding to a particular value of the half width
at half minimum:
%
\begin{align}
    \label{eq:hwhm}
    \rho'(\Delta\theta) =
    \left(\dfrac{1 +
        \cos\left(\dfrac{2\Delta\theta}{3}\right) +
        \sqrt{3}\sin\left(\dfrac{2\Delta\theta}{3}\right)}
    {2 \cos\Delta\theta}\right) - 1
    \quad.
\end{align}
%

\begin{figure}[p!]
    \begin{centering}
        \includegraphics[width=\linewidth]{figures/spot_expansion.pdf}
        \oscaption{spot_expansion}{%
            \emph{Top.}
            Polar intensity profiles for spots with different normalized
            radii $\rho$ in the range $(0, 1]$, computed at spherical harmonic
            degree $l_{\mathrm{max}} = \LMAX$.
            \emph{Bottom.}
            The width $\Delta\theta$
            (Equation~\ref{eq:hwhm}) of the
            spot as a function of the radius parameter $r$ (left panel)
            and the normalized radius $\rho$ (right panel), computed for
            $l_{\mathrm{max}} = \LMAX$.
            \label{fig:spot_expansion}
        }
    \end{centering}
\end{figure}

\subsubsection{Finite $l_{\mathrm{max}}$}
%
The
properties of the spot expansion described above
(in particular its monotonicity and values at the spot center and antipode)
are inherited from the generating function of the Legendre polynomials
(Equation~\ref{eq:gen}). These properties are therefore only rigorously
true when the expansion is taken to spherical
harmonic degree $l_{\mathrm{max}} = \infty$. Expansions truncated to finite
$l_{\mathrm{max}}$ will in general experience ringing and a spot amplitude
whose (absolute) value is in general smaller than unity.

To mitigate these issues, we will do two things: we will impose a minimum
radius $r_{\mathrm{min}}$ to prevent highly oscillatory behavior within
the domain of our function; and we will scale the spot expansion
by an overall amplitude factor so that
the peak spot intensity is as close to (negative) unity as possible
everywhere within the domain.
We find that this can be accomplished by expressing the
$n^{\mathrm{th}}$ term in the spot expansion $\mathbf{s}$ as
%
\begin{align}
    s_n(\rho) = s_n'\left( \rho' \right) \left(1 + c_2 \left(1 - \rho\right) ^ {c_3}\right)
\end{align}
%
where
%
\begin{align}
    \begin{split}
        \rho' &= \rho'\left(\rho\right) \\ &\equiv c_0 + c_1\rho
        \quad.
    \end{split}
\end{align}
%
and $c_0, c_1, c_2, c_3$ are constants at a given
value of $l_{\mathrm{max}}$.
%
Plugging this into Equation~(\ref{eq:sinf}), we have
%
\begin{align}
    \label{eq:s}
    s_{n}(\rho) =
    -\dfrac{1 + c_2 \left(1 - \rho\right) ^ {c_3}}{2\sqrt{2l + 1}}
    \begin{cases}
        \dfrac{\rho'}{1 + \rho'}
         & l = m = 0
        \\[1em]
        \dfrac{ \rho' \left( 2 + \rho' \right)}
        {\left(1 + \rho'\right)^{l + 1}}
         & l > 0, \, m = 0
        \\[1em]
        0
         & \mathrm{otherwise}
    \end{cases}
    \quad.
\end{align}
%
Note that in the limit $l_{\mathrm{max}} \rightarrow \infty$, we may set
$c_0 = 0$, $c_1 = 1$, and $c_2 = 0$ to recover the original parametrization.
At finite $l_{\mathrm{max}}$, however, we solve for the $c_n$ numerically,
by requiring the following conditions:

\xxx{TODO...}

\subsection{PDF}
\label{sec:size-pdf}
%
Our goal now is to characterize the distribution of $\mathbf{s}$ as a
function of parameters $\pmb{\theta}_r$ describing the distribution of
spot radii. Since $r \in [0, 1]$, we choose to model $r$ as a random
Beta-distributed variable; as we will see, this choice will allow us to
analytically compute the first two moments of the distribution of
$\mathbf{s}$ conditioned on $\pmb{\theta}_r$.

%
The Beta distribution in $r$ has hyperparameters
%
\begin{align}
    \pmb{\theta}_r = \left(
    \alpha \, \, \, \,
    \beta \right)^\top
\end{align}
%
and PDF given by
%
\begin{align}
    \label{eq:pdf_r}
    p \big(r \, \big| \, \pmb{\theta}_r \big)
     & =
    \dfrac{\Gamma(\alpha + \beta)}{\Gamma(\alpha)\Gamma(\beta)}
    r^{\alpha - 1}
    (1 - r)^{\beta - 1}
    \quad,
\end{align}
%
with support in $0 \leq r \leq 1$,
where $\Gamma$ is the Gamma function.

\subsection{First moment}
\label{sec:size-mom1}
%
The first moment of $\mathbf{s}$ is given by Equation~(\ref{eq:e1}).
We may use Equations~(\ref{eq:sinf}) and (\ref{eq:pdf_r}) to write the
$n^{\mathrm{th}}$ term of $\mathbf{{e_1}}(\pmb{\theta}_r)$ as
%
\begin{align}
    {e_1}_n(\alpha, \beta)
     & =
    \resizebox{.75\hsize}{!}{$
            \begin{dcases}
                -\dfrac{\Gamma(\alpha + \beta)}{\Gamma(\alpha)\Gamma(\beta)}
                \int\limits_0^1
                \dfrac{
                    (c_0 + c_1 r)
                    r^{\alpha - 1}
                    (1 - r)^{\beta - 1}
                }{2 (1 + c_0 + c_1 r)}
                \mathrm{d} r
                 &
                \qquad
                l = m = 0    \\[2em]
                -\dfrac{\Gamma(\alpha + \beta)}{\Gamma(\alpha)\Gamma(\beta)}
                \int\limits_0^1
                \dfrac{(c_0 + c_1 r) \left( 2 + c_0 + c_1 r \right)r^{\alpha - 1}
                (1 - r)^{\beta - 1}}
                {2 \sqrt{2l + 1} (1 + c_0 + c_1 r)^{l + 1}}
                \mathrm{d} r
                 &
                \qquad
                l > 0, m = 0 \\[2em]
                0
                 &
                \qquad m \ne 0
                \quad.
            \end{dcases}
        $}
\end{align}
%
Thanks to the dependence of the spherical harmonic coefficients on only
powers of $r$ and $(1 + c_0 + c_1 r)$, the integrals above may be expressed in closed
form in terms of the hypergeometric function ${_2F_1}$:
%
\begin{align}
    {e_1}_n(\alpha, \beta)
     & =
    \resizebox{.75\hsize}{!}{$
            \begin{dcases}
                -
                \dfrac{1}{2(1 + c_0)}
                \bigg[c_0H_0^0 + c_1 H_0^1\bigg]
                 &
                \qquad
                l = m = 0    \\[2em]
                -\dfrac{1}{2\sqrt{2l + 1} (1 + c_0)^{l+1}}
                \bigg[
                    c_0(2+c_0)H_l^0
                    +
                    2c_1(1 + c_0)H_l^1
                    +
                    c_1^2 H_l^2
                    \bigg]
                 &
                \qquad
                l > 0, m = 0 \\[2em]
                0
                 &
                \qquad m \ne 0
            \end{dcases}
        $}
\end{align}
%
where we define
%
\begin{align}
    H_j^k & \equiv \left(\prod_{n=0}^{k-1} \lambda_n\right) G_j^k
    \quad.
\end{align}
%
with
%
\begin{align}
    \lambda_n & \equiv \dfrac{\alpha + n}{\alpha + \beta + n}
\end{align}
%
and
%
\begin{align}
    G_j^k & \equiv {_2F_1}\left(j + 1, \alpha + k; \alpha + \beta + k; -\dfrac{c_1}{1 + c_0}\right)
    \quad.
\end{align}
%
Note that for fixed $\alpha$, $\beta$, $c_0$, and $c_1$, we need only compute
$G_0^0$, $G_1^0$, $G_0^1$, and $G_1^1$ directly, since the remaining terms may be
obtained recursively:
%
\begin{proof}{test_hypgeo}
    \label{eq:Grec}
    \begin{split}
        G_j^k & =
        \bigg[
            \dfrac{(\alpha + \beta + k - j)(1 + c_0)}{j(1 + c_0 + c_1)}
            \bigg] G_{j - 2}^k
        \\[0.75em]
        &
        + \hspace{1.5pt}
        \bigg[
            1 - \dfrac{(\alpha + \beta + k - j)(1 + c_0) + (\alpha + k)c_1}
            {j(1 + c_0 + c_1)}
            \bigg]
        G_{j - 1}^k
        \\[1.5em]
        G_j^k & =
        \bigg[
            \frac{(\alpha + \beta + k - 2)(1 + c_0)}
            {(\alpha + \beta - j + k - 2)\lambda_{k - 1}c_1}
            \bigg]
        G_{j}^{k - 2}
        \\[0.75em]
        & + \hspace{1.5pt}
        \bigg[
            \frac{1}{\lambda_{k - 1}}
            -\frac{(\alpha + \beta + k - 2)(1 + c_0) + \beta c_1}
            {(\alpha + \beta - j + k - 2)\lambda_{k-1}c_1}
            \bigg]
        G_{j}^{k - 1}
        \quad.
    \end{split}
    \raisetag{7.5em}
\end{proof}
%

%
\vspace{1em}
%

\subsection{Second moment}
\label{sec:size-mom2}
%
The second moment of $\mathbf{s}$ is given by Equation~(\ref{eq:E1}).
We may again use Equations~(\ref{eq:sinf}) and (\ref{eq:pdf_r}) to write the
term at index $(n, n')$ of $\mathbf{{E_1}}(\pmb{\theta}_r)$ as
%
\begin{align}
    {E_1}_{n,n'} (\alpha, \beta) & =
    \resizebox{1.5\hsize}{!}{$
            \begin{dcases}
                \dfrac{\Gamma(\alpha + \beta)}{\Gamma(\alpha)\Gamma(\beta)}
                \int\limits_0^1
                \left(
                \dfrac{c_0 + c_1 r}{2 (1 + c_0 + c_1 r)}
                \right)^2
                \\
                \qquad\qquad\quad\quad\quad\quad\quad
                \times
                \,\,
                r^{\alpha - 1}
                (1 - r)^{\beta - 1}
                \mathrm{d} r
                 &
                \qquad
                \parbox[t]{\linewidth}{\vspace{-2.5em}$l = l' = 0, \\m = m' = 0$}
                \\[2em]
                %
                %
                %
                \dfrac{\Gamma(\alpha + \beta)}{\Gamma(\alpha)\Gamma(\beta)}
                \int\limits_0^1
                \left(
                \dfrac{(c_0 + c_1 r)}{2 (1 + c_0 + c_1 r)}
                \right)
                \\
                \qquad\qquad\quad\quad\quad\quad\quad
                \times
                %
                \left(
                \dfrac{(c_0 + c_1 r) \left( 2 + c_0 + c_1 r \right)}
                    {2 \sqrt{2l + 1} (1 + c_0 + c_1 r)^{l + 1}}
                \right)
                %
                \\[0.75em]
                \qquad\qquad\quad\quad\quad\quad\quad
                \times
                \,\,
                r^{\alpha - 1}
                (1 - r)^{\beta - 1}
                \mathrm{d} r
                 &
                \qquad
                \parbox[t]{\linewidth}{\vspace{-5em}$l > 0,        \\l' = 0, \\m = m' = 0$}
                \\[2em]
                %
                %
                %
                \dfrac{\Gamma(\alpha + \beta)}{\Gamma(\alpha)\Gamma(\beta)}
                \int\limits_0^1
                \left(
                \dfrac{(c_0 + c_1 r) \left( 2 + c_0 + c_1 r \right)}
                    {2 \sqrt{2l + 1} (1 + c_0 + c_1 r)^{l + 1}}
                \right)
                \\
                \qquad\qquad\quad\quad\quad\quad\quad
                \times
                %
                \left(
                \dfrac{(c_0 + c_1 r) \left( 2 + c_0 + c_1 r \right)}
                    {2 \sqrt{2l' + 1} (1 + c_0 + c_1 r)^{l' + 1}}
                \right)
                %
                \\[0.75em]
                \qquad\qquad\quad\quad\quad\quad\quad
                \times
                \,\,
                r^{\alpha - 1}
                (1 - r)^{\beta - 1}
                \mathrm{d} r
                 &
                \qquad
                \parbox[t]{\linewidth}{\vspace{-5em}$l > 0,        \\l' > 0, \\m = m' = 0$}
                \\[2em]
                %
                %
                %
                0
                 &
                \qquad m, m' \ne 0
                \quad,
            \end{dcases}
        $}
    \raisetag{15.5em}
\end{align}
%
where $l' = l'(n')$ and $m' = m'(n')$ are again given by Equation~(\ref{eq:lm})
and, by symmetry, the expression for $l' > 0, \, l = 0, \, m = m' = 0$ is the same as
in the second case, provided we make the substitution $l \rightarrow l'$.
%
These integrals again reduce to closed form expressions:
%
\begin{align}
    {E_1}_{n,n'} (\alpha, \beta) & =
    \resizebox{1.4\hsize}{!}{$
            \begin{dcases}
                \dfrac{1}{4(1+c_0)^2}
                \bigg(
                c_0^2 H_1^0
                +
                2 c_0 c_1 H_1^1
                +
                c_1^2 H_1^2
                \bigg)
                 &
                \qquad
                \parbox[t]{\linewidth}{\vspace{-1.5em}$l = l' = 0, \\m = m' = 0$}
                \\[2em]
                %
                %
                %
                \dfrac{1}{4\sqrt{2l + 1}(1+c_0)^{l+2}}
                \\[0.75em]
                \enspace\quad
                \times
                \bigg(
                c_0^2(2 + c_0) H_{l+1}^0
                + c_0 c_1 (4 + 3 c_0) H_{l+1}^1
                \\[0.75em]
                \qquad
                + (2 + 3 c_0) c_1^2 H_{l + 1}^2
                + c_1^3 H_{l + 1}^3
                \bigg)
                 &
                \qquad
                \parbox[t]{\linewidth}{\vspace{-5.5em}$l > 0,      \\l' = 0, \\m = m' = 0$}
                \\[2em]
                %
                %
                %
                \dfrac{1}{4\sqrt{(2l + 1)(2l' + 1)}(1+c_0)^{l+l'+2}}
                \\[0.75em]
                \enspace\quad
                \times
                \bigg[
                    c_0^2(2+c_0)^2 H_{l + l' + 1}^0
                    + 4 c_0 (1 + c_0) (2 + c_0) c_1 H_{l + l' + 1}^1
                    \\[0.75em]
                \qquad
                + 2 \big(2 + 3 c_0 (2 + c_0)\big)c_1^2 H_{l + l' + 1}^2
                + 4(1 + c_0)c_1^3 H_{l + l' + 1}^3
                \\[0.75em]
                \qquad
                + c_1^4 H_{l + l' + 1}^4
                \bigg]
                 &
                \qquad
                \parbox[t]{\linewidth}{\vspace{-6em}$l > 0,        \\l' > 0, \\m = m' = 0$}
                \\[2em]
                %
                %
                %
                0
                 &
                \qquad m, m' \ne 0
                \quad.
            \end{dcases}
        $}
    \raisetag{13.5em}
\end{align}
%

\section{The Latitude Integrals: \lowercase{$\mathbf{e_2}$} and $\mathbf{E_2}$}
\label{sec:latitude}
\xxx{TODO.}

\section{The Longitude Integrals: \lowercase{$\mathbf{e_3}$} and $\mathbf{E_3}$}
\label{sec:longitude}
\xxx{TODO.}

\section{The Contrast Integrals: \lowercase{$\mathbf{e_4}$} and $\mathbf{E_4}$}
\label{sec:contrast}
%
\subsection{Functional form}
\label{sec:contrast-function}
Since the spot function $\mathbf{s}$ (Equation~\ref{eq:sinf}) is normalized
to $-1$, we may simply scale it by the contrast $\xi$ to obtain a spot
whose peak intensity is $-\xi$.
Assuming the baseline (unspotted) stellar intensity is unity, $\xi$
is the fractional decrease in the brightness relative to the stellar
baseline: i.e., the spot contrast.
%

\subsection{PDF}
\label{sec:contrast-pdf}
We require our
spot contrast to be no larger than $1$ (corresponding to zero intensity
at the center of the spot when the baseline is unity) to enforce physical
intensities
everywhere. We have thus far implicitly assumed the spot is dark, but
in principle bright spots may also exist
(such as the plages observed on the Sun), corresponding to contrasts
$\xi < 0$. We therefore require a PDF with support over $(-\infty, 1)$.
Defining
%
\begin{align}
    b(\xi) \equiv 1 - \xi
\end{align}
%
to be the actual brightnesss of a unit-intensity stellar surface at
the center of the spot,
we can obtain the required support by modeling
$b \in (0, \infty)$ as a log-normal
random variable:
%
\begin{align}
    \label{eq:lognormal}
    p \big(b \, \big| \, \mu, \nu \big)
     & =
    \frac{1}{b\sqrt{2\pi\nu}}
    \exp\left[
        -\dfrac{\big(\ln b - \mu\big)^2}{2\nu}
        \right]
    \quad.
\end{align}
%
where $\mu$ and $\nu$ are the mean and variance in $b$, respectively.
The corresponding PDF in terms of $\xi$ is
%
\begin{align}
    \label{eq:lognormal}
    p \big(\xi \, \big| \, \pmb{\theta}_\xi \big)
     & =
    \frac{1}{(1 - \xi)\sqrt{2\pi\nu}}
    \exp\left[
        -\dfrac{\big(\ln (1 - \xi) - \mu\big)^2}{2\nu}
        \right]
    \quad.
\end{align}
%
where the hyperparameters are
%
\begin{align}
    \pmb{\theta}_\xi = \left(
    \mu \, \, \, \,
    \nu \right)^\top
    \quad.
\end{align}
%

\subsection{First moment}
\label{sec:contrast-mom1}
The first moment of the spot contrast distribution is given by
Equation~(\ref{eq:e4}), which may easily be solved analytically:
%
\begin{align}
    \mathbf{e_4}(\pmb{\theta}_\xi, \mathbf{e_3})
     & =
    \int_{-\infty}^1
    \xi \,
    \mathbf{e_3} \,
    p(\xi \, \big| \, \pmb{\theta}_{\xi}) \,
    \mathrm{d}\xi
    \nonumber
    \\
     & =
    \left(1 - \exp\left[ \mu + \frac{1}{2}\nu\right]\right) \mathbf{e_3}
    \quad.
\end{align}
%

\subsection{Second moment}
\label{sec:contrast-mom2}
The second moment of the spot contrast distribution is given by
Equation~(\ref{eq:E4}), which also evaluates to a simple closed form:
%
\begin{align}
    \mathbf{E_4}(\pmb{\theta}_\xi, \mathbf{E_3})
     & =
    \int_{-\infty}^1
    \xi^2 \,
    \mathbf{E_3} \,
    \mathbf{E_3}^\top \,
    p(\xi \, \big| \, \pmb{\theta}_{\xi}) \,
    \mathrm{d}\xi
    \nonumber
    \\
     & =
    \left(1 - 2\exp\bigg[ \mu + \frac{1}{2}\nu\bigg]
    + \exp\bigg[ 2\mu + 2\nu\bigg]\right)
    \mathbf{E_3} \,
    \mathbf{E_3}^\top
    \quad.
\end{align}



\bibliography{bib}
\end{document}