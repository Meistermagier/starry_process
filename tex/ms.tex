% !TeX root = ./ms.tex
\documentclass[modern]{aastex62}

% Load the corTeX style definitions
\input{cortex}

% Load custom style
\input{style}

% Bibliography
\bibliographystyle{aasjournal}

\usepackage{etoolbox}
\makeatletter % we need to patch \env@cases that has @ in its name
\patchcmd{\env@cases}{\quad}{\qquad\qquad}{}{}
\makeatother

\usepackage{enumitem}

% Begin!
\begin{document}

% Title
\title{%
    \textbf{
        Interpretable Gaussian Processes for Stellar Light Curves
    }
}

% Author list
\author[0000-0002-0296-3826]{Rodrigo Luger}\altaffiliation{Flatiron Fellow}
\email{rluger@flatironinstitute.org}
\affil{Center~for~Computational~Astrophysics, Flatiron~Institute, New~York, NY}
\affil{Virtual~Planetary~Laboratory, University~of~Washington, Seattle, WA}
%

\keywords{methods: analytic}

% \begin{abstract}
%     Abstract here.
%     %
%     \href{https://github.com/rodluger/starry_process}{\color{linkcolor}\faGithub}
% \end{abstract}

\section{Introduction}
\label{sec:intro}
\xxx{Talk about starry, gps, and whatnot.}

\section{Spherical Harmonics}
\label{sec:ylm}
%
\xxx{Introduce the spherical harmonics.}

The real spherical harmonics are indexed by their degree $l \in [0, \infty]$
and order $m \in [-l, l]$. It is convenient to collect the spherical harmonic coefficients of
a given expansion into a vector $\mathbf{y}$ indexed by a single
integer $n$, where
%
\begin{align}
    \label{eq:n}
    n = l^2 + l + m
\end{align}
%
and, conversely,
%
\begin{align}
    \label{eq:lm}
    \begin{split}
        l & = \floor{\sqrt{n}}
        \\
        m & = n - l^2 - l
        \quad.
    \end{split}
\end{align}

\section{Variational Inference}
\label{sec:variational}
%
\xxx{Explain what we're doing and the connection between our GP and VI.}

The mean $\pmb{\mu}$ and covariance $\pmb{\Sigma}$ of the flux GP are given by
%
\begin{align}
    \label{eq:mean}
    \pmb{\mu}(\pmb{\theta})
     & = \mathrm{E} \Big[ \mathbf{f}(\pmb{\theta}) \, \Big| \, \pmb{\theta} \Big]
    \\
    \label{eq:cov}
    \pmb{\Sigma}(\pmb{\theta})
     & = \mathrm{E} \Big[ \mathbf{f}(\pmb{\theta}) \, \mathbf{f}^\top(\pmb{\theta}) \, \Big| \, \pmb{\theta} \Big] - \pmb{\mu}^2(\pmb{\theta})
\end{align}
%
where $\mathrm{E}[\cdots]$ denotes the expectation value,
$\mathbf{f}$ is a random vector-valued variable corresponding to
a set of flux measurements, $\pmb{\theta}$ is a vector
of hyperparameters on which the GP depends, and the squaring operation in
Equation~(\ref{eq:cov}) is performed element-wise.
The vector $\pmb{\theta}$ includes physical properties of the star such
as its inclination $i$ and rotational period $P$ as well as parameters
describing the shape of the probability density function (PDF) governing
the distribution of features on the surface.
%
Since the flux
$\mathbf{f}$ is linear in
the spherical harmonic coefficient vector $\mathbf{y}$,
%
\begin{align}
    \label{eq:fAy}
    \mathbf{f}(\pmb{\theta}) = \mathbf{A}(\pmb{\theta}) \, \mathbf{y}
    \quad,
\end{align}
%
where $\mathbf{A}$ is the \starry design matrix \citep{Luger2019},
we may write the mean and covariance as
%
\begin{align}
    \pmb{\mu}(\pmb{\theta})
     & = \mathbf{A}(\pmb{\theta}) \, \pmb{\mu}_{\mathbf{y}}(\pmb{\theta})
    \\
    \pmb{\Sigma}(\pmb{\theta})
     & = \mathbf{A}(\pmb{\theta}) \, \pmb{\Sigma}_{\mathbf{y}} \, \mathbf{A}^\top(\pmb{\theta})
    \quad,
\end{align}
%
where
%
\begin{align}
    \label{eq:mean_y}
    \pmb{\mu}_{\mathbf{y}}(\pmb{\theta})
     & = \mathrm{E} \Big[ \mathbf{y} \, \Big| \, \pmb{\theta} \Big]
    \\
    \label{eq:cov_y}
    \pmb{\Sigma}_{\mathbf{y}}(\pmb{\theta})
     & = \mathrm{E} \Big[ \mathbf{y} \, \mathbf{y}^\top \, \Big| \, \pmb{\theta} \Big] - \pmb{\mu}_{\mathbf{y}}^2(\pmb{\theta})
\end{align}
%
are the mean and covariance of the spherical harmonic GP.
The expectation values in Equations~(\ref{eq:mean_y}) and (\ref{eq:cov_y})
above are given by the integrals
%
\begin{align}
    \label{eq:exp_y}
    \mathrm{E} \Big[ \mathbf{y} \, \Big| \, \pmb{\theta} \Big]
     & =
    \int \mathbf{y}(\mathbf{x} ) \, p(\mathbf{x} \, \big| \, \pmb{\theta})\mathrm{d}\mathbf{x}
    \\
    \label{eq:exp_yy}
    \mathrm{E} \Big[ \mathbf{y} \, \mathbf{y}^\top \, \Big| \, \pmb{\theta} \Big]
     & =
    \int \mathbf{y}(\mathbf{x} ) \mathbf{y}^\top(\mathbf{x} ) \, p(\mathbf{x} \, \big| \, \pmb{\theta})\mathrm{d}\mathbf{x}
    \quad,
\end{align}
%
where $\mathbf{x}$ is a random vector-valued variable corresponding to a particular
distribution of features on the surface and
$p(\mathbf{x} \, \big| \, \pmb{\theta})$ is its PDF.

The goal of this paper is to show that for suitable choices of $\mathbf{y}(\mathbf{x})$
and $p(\mathbf{x} \, \big| \, \pmb{\theta})$, the integrals in the expressions
above have closed form solutions that may be evaluated quickly.
%
As we are specifically interested in modeling the effect of star spots
on stellar light curves, we let
%
\begin{align}
    \mathbf{x} = \big\{ \varphi, \lambda, \delta, r \big\}
\end{align}
%
and
%
\begin{align}
    \label{eq:RRs}
    \mathbf{y}(\mathbf{x}) =
    \mathbf{R}_{\hat{\mathbf{y}}}(\lambda)
    \,
    \mathbf{R}_{\hat{\mathbf{x}}}(\phi)
    \,
    \mathbf{s}(\delta, r)
    \quad,
\end{align}
%
where $\lambda$ is the longitude of a spot, $\phi$ is its latitude, $\delta$
is its contrast, and $r$ is its radius. The vector function $\mathbf{s}(\delta, r)$
returns the spherical harmonic expansion of a circular spot at $\lambda = \phi = 0$,
$\mathbf{R}_{\hat{\mathbf{x}}}(\phi)$ is the Wigner matrix that rotates the
expansion about $\hat{\mathbf{x}}$ such that the spot is centered at a
latitude $\phi$, and $\mathbf{R}_{\hat{\mathbf{y}}}(\lambda)$ is the Wigner
matrix that then rotates the
expansion about $\hat{\mathbf{y}}$ such that the spot is centered at a
longitude $\lambda$; these three functions are detailed in the sections below.
%
Equation~(\ref{eq:RRs}) thus provides a way of converting a random variable
$\mathbf{x}$ describing the size, contrast, and position of a spot to the
corresponding representation in terms of spherical harmonics.
%
Note, importantly, that we are not interested in any specific value of
$\mathbf{y}$; rather, we would like to know its expectation value under
the probability distribution governing the different spot properties $\mathbf{x}$,
i.e., $p(\mathbf{x} \, \big| \, \pmb{\theta})$.
%
For simplicity, we assume that $p(\mathbf{x} \, \big| \, \pmb{\theta})$
is separable in each of the four spot properties:
%
\begin{align}
    p(\mathbf{x} \, \big| \, \pmb{\theta})
    =
    p(\lambda \, \big| \, \pmb{\theta}_{\lambda}) \,
    p(\phi \, \big| \, \pmb{\theta}_{\phi})\,
    p(\delta \, \big| \, \pmb{\theta}_{\delta}) \,
    p(r \, \big| \, \pmb{\theta}_{r})
    \quad,
\end{align}
%
where
%
\begin{align}
    \pmb{\theta} = \big\{
    \pmb{\theta}_{\lambda}, \,
    \pmb{\theta}_{\phi}, \,
    \pmb{\theta}_{\delta}, \,
    \pmb{\theta}_{r} \big\}
    \quad.
\end{align}
%
This allows us to rewrite the expectation integrals (\ref{eq:exp_y})
and (\ref{eq:exp_yy}) as
%
\begin{align}
    \label{eq:exp_y_sep}
    \mathrm{E} \Big[ \mathbf{y} \, \Big| \, \pmb{\theta} \Big]
     & =
    \mathbf{e_3}(\pmb{\theta})
\end{align}
\begin{align}
    \label{eq:exp_yy_sep}
    \mathrm{E} \Big[ \mathbf{y} \, \mathbf{y}^\top \, \Big| \, \pmb{\theta} \Big]
     & =
    \mathbf{E_3}(\pmb{\theta})
\end{align}
%
where we define the first moment integrals
%
\begin{align}
    \mathbf{e_1}(\pmb{\theta}_r, \pmb{\theta}_\delta)
     & =
    \iint
    \mathbf{s}(\delta, r) \,
    p(r \, \big| \, \pmb{\theta}_{r}) \,
    \mathrm{d}r \,
    p(\delta \, \big| \, \pmb{\theta}_{\delta}) \,
    \mathrm{d}\delta
    %
    \\[1em]
    %
    \mathbf{e_2}(\pmb{\theta}_\phi, \mathbf{e_1})
     & =
    \int
    \mathbf{R}_{\hat{\mathbf{x}}}(\phi) \,
    \mathbf{e_1} \,
    p(\phi \, \big| \, \pmb{\theta}_{\phi}) \,
    \mathrm{d}\phi
    %
    \\[1em]
    %
    \mathbf{e_3}(\pmb{\theta}_\lambda, \mathbf{e_2})
     & =
    \int
    \mathbf{R}_{\hat{\mathbf{y}}}(\lambda) \,
    \mathbf{e_2} \,
    p(\lambda \, \big| \, \pmb{\theta}_{\lambda}) \,
    \mathrm{d}\lambda
\end{align}
%
and the second moment integrals
%
\begin{align}
    \mathbf{E_1}(\pmb{\theta}_r, \pmb{\theta}_\delta)
     & =
    \iint
    \mathbf{s}(\delta, r) \, \mathbf{s}^\top(\delta, r) \,
    p(r \, \big| \, \pmb{\theta}_{r}) \,
    \mathrm{d}r \,
    p(\delta \, \big| \, \pmb{\theta}_{\delta})
    \mathrm{d}\delta
    %
    \\[1em]
    %
    \mathbf{E_2}(\pmb{\theta}_\phi, \mathbf{E_1})
     & =
    \int
    \mathbf{R}_{\hat{\mathbf{x}}}(\phi) \,
    \mathbf{E_1} \,
    \mathbf{E_1}^\top \,
    \mathbf{R}_{\hat{\mathbf{x}}}^\top(\phi) \,
    p(\phi \, \big| \, \pmb{\theta}_{\phi})
    \mathrm{d}\phi
    %
    \\[1em]
    %
    \mathbf{E_3}(\pmb{\theta}_\lambda, \mathbf{E_2})
     & =
    \int
    \mathbf{R}_{\hat{\mathbf{y}}}(\lambda) \,
    \mathbf{E_2} \,
    \mathbf{E_2}^\top \,
    \mathbf{R}_{\hat{\mathbf{y}}}^\top(\lambda) \,
    p(\lambda \, \big| \, \pmb{\theta}_{\lambda})
    \mathrm{d}\phi
    \quad.
\end{align}
%
We devote the next three sections to the computation of these
integrals.

%
\section{The Spot Integrals: \lowercase{$\mathbf{e_1}$} and $\mathbf{E_1}$}
\label{sec:spot}
%
\subsection{Preliminaries}
%
\subsubsection{Functional form}
\label{sec:spot-function}
%
We adopt the following expression for the $n^{\mathrm{th}}$ term in $\mathbf{s}$
in the expansion of a spot at
$\theta = \varphi = 0$:
%
\begin{align}
    \label{eq:s}
    s_{n}(\delta, r) =
    \begin{cases}
        1 - \dfrac{\delta r'}{2 (1 + r')}
         & l = m = 0    \\[2em]
        -\dfrac{\delta r' \left( 2 + r' \right)}
        {2 \sqrt{2l + 1} (1 + r')^{l + 1}}
         & l > 0, m = 0 \\[2em]
        0
         & m \ne 0
    \end{cases}
\end{align}
%
where
%
\begin{align}
    \label{eq:rprime}
    r' \equiv c_0 + c_1 r
\end{align}
%
and $c_0, c_1 > 0$ are scaling constants (defined in more detail below).
In the expressions above,
$\delta \in (-\infty, 1]$ is the spot contrast (the fractional
decrease in the brightness
at the center of the spot) and $r \in [0, 1]$ is the normalized spot radius.
The expression in Equation~(\ref{eq:s}) is convenient because it satisfies
six important properties:
%
\begin{enumerate}[itemsep=2pt,parsep=1pt,label=\textbf{\arabic*}]
    \item The surface intensity is azimuthally symmetric about the spot center
    \item The surface intensity monotonically increases away from the spot center
    \item The surface intensity at the spot center is $1 - \delta$
    \item The surface intensity at the antipode of the spot center is unity
    \item The size of the spot increases monotonically with $r$
\end{enumerate}
%
These properties may be demonstrated by considering the
expression for the surface intensity at a given point $(\theta, \varphi)$:
%
\begin{align}
    \begin{split}
        I(\theta, \varphi)
        & =
        \sum\limits_{n=0}^\infty
        s_{n} Y_{n}(\theta, \varphi) \\
        & =
        \sum\limits_{n=0}^\infty
        \begin{cases}
            s_{n} \sqrt{2l + 1} P_l(\cos\theta)
              & m = 0              \\[2em]
            0 & \mathrm{otherwise}
        \end{cases}
    \end{split}
\end{align}
%
where $Y_n$ is the spherical harmonic of degree $l(n)$ and order $m(n)$
(see Equation~\ref{eq:lm}),
$P_l$ is the Legendre polynomial of degree $l$ and we have implicitly
assumed a normalization such that the integral of our expansion over
the unit sphere is $4\pi$.
Note that the expression above is independent of the azimuth $\varphi$,
a consequence of the fact that all harmonics with $m \ne 0$ are zero; this
expansion is therefore azimuthally symmetric about the spot center, as
stated in \textbf{1}.
%
Combining the above expression with Equation~(\ref{eq:s}) and
rearranging, we may write
%
\begin{align}
    \label{eq:Igen}
    I(\theta, \varphi) =
    I(\theta) =
    1 + \dfrac{\delta r'}{2}
    -
    \dfrac{\delta r' \left( 2 + r' \right)}{2 (1 + r')}
    \sum\limits_{l=0}^\infty \left(\dfrac{1}{1 + r'}\right)^l P_l(\cos\theta)
    \quad.
\end{align}
%
The summation in Equation~(\ref{eq:Igen}) has a closed-form expression in
terms of the generating function of the Legendre polynomials:
%
\begin{align}
    \label{eq:gen}
    \sum\limits_{l=0}^\infty t^l P_l(\cos\theta) = \frac{1}{\sqrt{1 + t^2 - 2 t \cos\theta}}
    \quad,
\end{align}
%
so we may express the intensity in the fairly simple form
%
\begin{align}
    \label{eq:Ifinal}
    I(\theta) & = A - \frac{B}{\sqrt{C - \cos\theta}}
    \quad,
    %
    \\
    \intertext{where}
    %
    \begin{split}
        A & = 1 + \dfrac{\delta r'}{2}                      \\
        B & = \delta r' (2 + r') \sqrt{\dfrac{1}{8 + 8 r'}} \\
        C & = \dfrac{1 + (1 + r')^2}{2 + 2 r'}
    \end{split}
\end{align}
%
are positive constants.

Differentiating Equation~(\ref{eq:Ifinal}) with respect to $\theta$, we have
%
\begin{align}
    \label{eq:Ideriv}
    \dfrac{\mathrm{d}I(\theta)}{\mathrm{d}\theta} & =
    -\frac{B\sin\theta}{2(C - \cos\theta)^\frac{3}{2}}
    \quad,
\end{align}
%
which is zero only for $\theta = 0$ (for which $I(\theta)$ is
minimized) and $\theta = \pi$ (for which it is maximized). The intensity
therefore increases monotonically from the spot center to the antipode,
as stated in \textbf{2}. The value at the minimum is
%
\begin{align}
    \begin{split}
        I_{\mathrm{min}} & = A - \dfrac{B}{\sqrt{C - 1}} \\
        & = 1 - \delta
        \quad,
    \end{split}
\end{align}
%
as stated in \textbf{3}, and the value at the maximum is
%
\begin{align}
    \begin{split}
        I_{\mathrm{max}} & = A - \dfrac{B}{\sqrt{C + 1}} \\
        & = 1
        \quad,
    \end{split}
\end{align}
%
as stated in \textbf{4}.
Finally, to show \textbf{5}, let us compute the half width at half minimum
$\Delta\theta$ of the intensity profile:
%
\begin{align}
    1 - \left(A - \dfrac{B}{\sqrt{C - \cos{\Delta\theta}}}\right) =
    \dfrac{1}{2}\delta
\end{align}
%
Solving for $\Delta\theta$ yields
%
\begin{align}
    \label{eq:hwhm}
    \Delta\theta =
    \cos^{-1} \left[ \dfrac{2 + 3 r' (2 + r')}{2 (1 + r')^3} \right]
    \quad.
\end{align}
%
Differentiation with respect to $r'$ yields
%
\begin{align}
    \dfrac{\mathrm{d}\Delta\theta}{\mathrm{d}r'} =
    \frac{3 r' \left(2 + r'\right)}{\left(1 + r'\right)^4
        \sqrt{\frac{r'^2 \left(2 + r'\right)^2 \left(1 + 2 r'\right)
                \left(3 + 2 r'\right)}{\left(1 + r'\right)^6}}}
    \quad,
\end{align}
%
which is positive definite for all $r' > 0$.

\subsubsection{Behavior at finite degree}
%
The properties of the spot expansion described in the previous section
(in particular its monotonicity and values at the spot center and antipode)
are inherited from the generating function of the Legendre polynomials
(Equation~\ref{eq:gen}). These properties are therefore only rigorously
true when the expansion is taken to spherical
harmonic degree $l_{\mathrm{max}} = \infty$. For truncated expansions,
a value of $r'$ in Equation~(\ref{eq:s}) that is too small will lead
to both ringing and a value at the spot center that is in general larger
than $1 - \delta$.

\begin{figure}[p!]
    \begin{centering}
        \includegraphics[width=\linewidth]{figures/spot_expansion.pdf}
        \oscaption{spot_expansion}{%
            Polar intensity profiles for spots with different normalized
            radii $r$ in the range $(0, 1]$, computed at spherical harmonic
            degree $l_{\mathrm{max}} = 20$. Dotted black curves show profiles
            corresponding to $r < 0$ (corresponding to $r' < c_0$
            in Equation~\ref{eq:rprime}), for which the expansion does
            not converge, leading to ringing and a smaller spot contrast.
            \label{fig:spot_expansion}
        }
    \end{centering}
\end{figure}

\begin{figure}[p!]
    \begin{centering}
        \includegraphics[width=\linewidth]{figures/hwhm.pdf}
        \oscaption{hwhm}{%
            \emph{Left.} The width $\Delta\theta$
            (Equation~\ref{eq:hwhm}) of the
            spot as a function of the radius parameter $r'$ (bottom axis)
            and the normalized radius $r$ (top axis), computed for
            $l_{\mathrm{max}} = 20$. The green dots indicate the
            minimum value of $r'$ for which the fractional error in the
            spot intensity due
            to the truncated expansion is less than one percent
            and the value of $r'$ corresponding to
            $\Delta\theta = 75^\circ$, respectively. These points correspond to
            the minimum and maximum spot sizes we consider at
            $l_{\mathrm{max}} = 20$
            (blue shading). Note that
            in this regime, the width of the spot scales approximately
            logarithmically with $r'$.
            %
            \emph{Right.} The spot width $\Delta\theta$ below which the
            fractional error in the intensity exceeds various thresholds
            as a function of maximum spherical harmonic degree
            $l_{\mathrm{max}}$. The value of $\Delta\theta$ for a tolerance
            of one percent at $l_{\mathrm{max}} = 20$ is indicated as the
            green dot for reference.
            \label{fig:hwhm}
        }
    \end{centering}
\end{figure}

To circumvent these issues, we impose a minimum radius
$r'_{\mathrm{min}}$, whose value is
a function of the degree of the expansion. Since the normalized spot radius
$r$ is defined in the range $[0, 1]$ (Equation~\ref{eq:rprime}), this
minimum value is equal to $c_0$. We compute $c_0 = c_0(l_{\mathrm{max}})$
by numerically finding the
value of $r'$ below which the fractional error in the intensity at the
center of the spot exceeds some threshold, which we take to be 0.01.
Since the width of the spot $\Delta\theta$ approaches $\pi$ as
$r' \rightarrow \infty$ (Equation~\ref{eq:hwhm}), we also impose a
maximum radius $r'_{\mathrm{max}}$, which we define to be the radius
corresponding to
$\Delta\theta = \nicefrac{5\pi}{12} = 75^\circ$. This choice is rather
arbitrary, but motivated by the fact that below this value, $\Delta\theta$
scales approximately logarithmically with $r'$ (see Figure~\ref{fig:hwhm}).

\subsection{Probability distribution}
%
Our goal now is to characterize the distribution of $s_{n}$ values as a
function of certain statistics of the spots: specifically, the distribution of
spot radii and intensities. As we will see, if we model these with a Beta and
a log-normal distribution, respectively, we may analytically compute the
first two moments of the distribution of $s_{n}$ conditioned on the parameters
of these two prior distributions.

\subsubsection{Distributions over $r$ and $\delta$}
%
Since we require the normalized spot radius $r$ to be bounded
on the interval $[0, 1]$, we place a Beta prior on this quantity, whose
probability density function (PDF) is
%
\begin{align}
    p \big(r \, \big| \, \alpha, \beta \big)
     & =
    \dfrac{\Gamma(\alpha + \beta)}{\Gamma(\alpha)\Gamma(\beta)}
    r^{\alpha - 1}
    (1 - r)^{\beta - 1}
    \quad,
\end{align}
%
where $\Gamma$ is the Gamma function and $\alpha$ and $\beta$ are
hyperparameters characterizing the shape of the distribution.
%
And since we require the brightness
%
\begin{align}
    b \equiv 1 - \delta
\end{align}
%
at the center of the spot to
be non-negative, it is convenient to treat $b \in [0, \infty)$ as our
random variable instead of $\delta$. We therefore place a log-normal
prior on $b$, whose PDF is
%
\begin{align}
    \label{eq:lognormal}
    p \big(b \, \big| \, \mu, \nu \big)
     & =
    \frac{1}{b\sqrt{2\pi\nu}}
    \exp\left[
        -\dfrac{\left(\ln b - \mu\right)^2}{2\nu}
        \right]
    \quad,
\end{align}
%
where $\mu$ and $\nu$ are the mean and variance of the log-normal, respectively.
The joint distribution over $r$ and $b$ is therefore separable,
by construction:
%
\begin{align}
    p \big( r, b \, \big| \, \alpha, \beta, \mu, \nu \big)
     & =
    p \big(r \, \big| \, \alpha, \beta \big)
    \,
    p \big(b \, \big| \, \mu, \nu \big)
    \quad.
\end{align}
%
In the next two sections, we derive closed form expressions for the first
and second moments of the distribution
%
$p \big( s_{n} \, \big| \, \alpha, \beta, \mu, \nu \big)$.


\subsubsection{First moment}
%
The first moment of the distribution of $s_{n}$ over $r$ and $b$ is
%
\begin{align}
    \label{eq:Erb}
    \begin{split}
        \mathrm{E} \big[ s_{n} \big] &=
        \int\limits_0^\infty \int\limits_0^1
        s_{n} (r, 1 - b)
        p \big(r, 1 - b \, \big| \, \alpha, \beta, \mu, \nu \big)
        \mathrm{d} r
        \,
        \mathrm{d} b
        \\
        &=
        \int\limits_0^\infty
        \mathrm{E}_r \big[ s_{n} \big]
        p \big(b \, \big| \, \mu, \nu \big)
        \mathrm{d} b
        \quad,
    \end{split}
    %
    \\
    \intertext{where}
    \label{eq:Er}
    %
    \mathrm{E}_r \big[ s_{n} \big]
     & =
    \int\limits_0^1
    s_{n} (r, 1 - b)
    p \big(r \, \big| \, \alpha, \beta \big)
    \mathrm{d} r
    \quad.
\end{align}
%
Expanding Equation~(\ref{eq:Er}), we obtain
%
\begin{align}
    \mathrm{E}_r \big[ s_{n} \big]
     & =
    \resizebox{.75\hsize}{!}{$
            \begin{dcases}
                \dfrac{\Gamma(\alpha + \beta)}{\Gamma(\alpha)\Gamma(\beta)}
                \int\limits_0^1
                \left(
                1 - \dfrac{(1 - b) (c_0 + c_1 r)}{2 (1 + c_0 + c_1 r)}
                \right)
                r^{\alpha - 1}
                (1 - r)^{\beta - 1}
                \mathrm{d} r
                 &
                \qquad
                l = m = 0    \\[2em]
                -\dfrac{\Gamma(\alpha + \beta)}{\Gamma(\alpha)\Gamma(\beta)}
                \int\limits_0^1
                \dfrac{(1 - b) (c_0 + c_1 r) \left( 2 + c_0 + c_1 r \right)r^{\alpha - 1}
                (1 - r)^{\beta - 1}}
                {2 \sqrt{2l + 1} (1 + c_0 + c_1 r)^{l + 1}}
                \mathrm{d} r
                 &
                \qquad
                l > 0, m = 0 \\[2em]
                0
                 &
                \qquad m \ne 0
                \quad.
            \end{dcases}
        $}
\end{align}
%
Thanks to the dependence of the spherical harmonic coefficients on only
powers of $r$ and $(1 + c_0 + c_1 r)$, the integrals above may be expressed in closed
form in terms of the hypergeometric function ${_2F_1}$:
%
\begin{align}
    \mathrm{E}_r \big[ s_{n} \big]
     & =
    \resizebox{.75\hsize}{!}{$
            \begin{dcases}
                1 -
                \dfrac{(1 - b)}{2(1 + c_0)}
                \bigg[c_0H_0^0 + c_1 H_0^1\bigg]
                 &
                \qquad
                l = m = 0    \\[2em]
                -\dfrac{(1 - b)}{2\sqrt{2l + 1} (1 + c_0)^{l+1}}
                \bigg[
                    c_0(2+c_0)H_l^0
                    +
                    2c_1(1 + c_0)H_l^1
                    +
                    c_1^2 H_l^2
                    \bigg]
                 &
                \qquad
                l > 0, m = 0 \\[2em]
                0
                 &
                \qquad m \ne 0
            \end{dcases}
        $}
\end{align}
%
where we define
%
\begin{align}
    H_j^k & \equiv \left(\prod_{n=0}^{k-1} \lambda_n\right) G_j^k
    \quad.
\end{align}
%
with
%
\begin{align}
    \lambda_n & \equiv \dfrac{\alpha + n}{\alpha + \beta + n}
\end{align}
%
and
%
\begin{align}
    G_j^k & \equiv {_2F_1}\left(j + 1, \alpha + k; \alpha + \beta + k; -\dfrac{c_1}{1 + c_0}\right)
    \quad.
\end{align}
%
Note that for a given value of $\alpha$, $\beta$, and $c$, we need only compute
$G_0^0$, $G_1^0$, $G_0^1$, and $G_1^1$ directly, since the remaining terms may be
obtained recursively:
%
\begin{align}
    \label{eq:Grec}
    G_j^k & =
    \bigg[
        \dfrac{(\alpha + \beta + k - j)(1 + c_0)}{j(1 + c_0 + c_1)}
        \bigg] G_{j - 2}^k
    \nonumber
    \\[0.75em]
          &
    + \hspace{1.5pt}
    \bigg[
        -\dfrac{(\alpha + \beta - 2j + k)(1 + c_0) + (\alpha - j + k)c_1}
        {j(1 + c_0 + c_1)}
        \bigg]
    G_{j - 1}^k
    \\[1.5em]
    G_j^k & =
    \bigg[
        \frac{(\alpha + \beta + k - 2)(1 + c_0)}
        {\lambda_{k - 1}(\alpha + \beta - j + k - 2)c_1}
        \bigg]
    G_{j}^{k - 2}
    \nonumber
    \\[0.75em]
          & + \hspace{1.5pt}
    \bigg[
        -\frac{\alpha - (\alpha + k)c_1 + \beta + k + (\alpha + \beta + k - 2)c_0 + (j + 2)c_1 - 2}
        {\lambda_{k-1} (\alpha + \beta - j + k - 2)c_1}
        \bigg]
    G_{j}^{k - 1}
    \quad.
\end{align}
%
We may now evaluate the integral in Equation~(\ref{eq:Erb}), with
PDF given by Equation~(\ref{eq:lognormal}).
Most of the terms in the integrands are constants, so the
integrals are straightforward to evaluate and may also
be expressed in closed form:
%
\begin{align}
    \mathrm{E} \big[ s_{n} \big]
     & =
    \resizebox{.75\hsize}{!}{$
            \begin{dcases}
                1 -
                \dfrac{\gamma_1}{2(1 + c_0)}
                \bigg[c_0 H_0^0 + c_1 H_0^1\bigg]
                 &
                \qquad
                l = m = 0    \\[2em]
                -\dfrac{\gamma_1}{2\sqrt{2l + 1} (1 + c_0)^{l+1}}
                \bigg[
                    c_0(2+c_0)H_l^0
                    +
                    2c_1(1 + c_0)H_l^1
                    +
                    c_1^2 H_l^2
                    \bigg]
                 &
                \qquad
                l > 0, m = 0 \\[2em]
                0
                 &
                \qquad m \ne 0
            \end{dcases}
        $}
\end{align}
%
where we define
%
\begin{align}
    \gamma_1 \equiv 1 - \exp\left[ \mu + \frac{1}{2}\nu\right]
    \quad.
\end{align}
%

\subsubsection{Second moment}
%
The second moment of the distribution of $s_{n}$ over $r$ and $b$ is
%
\begin{align}
    \label{eq:Erb2}
    \begin{split}
        \mathrm{E} \big[ s_{n} s_{n'} \big] &=
        \int\limits_0^\infty \int\limits_0^1
        s_{n} (r, 1 - b)
        s_{n'} (r, 1 - b)
        p \big(r, 1 - b \, \big| \, \alpha, \beta, \mu, \nu \big)
        \mathrm{d} r
        \,
        \mathrm{d} b
        \\
        &=
        \int\limits_0^\infty
        \mathrm{E}_r \big[ s_{n} s_{n'} \big]
        p \big(b \, \big| \, \mu, \nu \big)
        \mathrm{d} b
        \quad,
    \end{split}
    %
    \\
    \intertext{where}
    \label{eq:Er2}
    %
    \mathrm{E}_r \big[ s_{n} s_{n'} \big]
     & =
    \int\limits_0^1
    s_{n} (r, 1 - b)
    s_{n'} (r, 1 - b)
    p \big(r \, \big| \, \alpha, \beta \big)
    \mathrm{d} r
    \quad.
\end{align}
%
Expanding Equation~(\ref{eq:Er2}), we obtain
%
\begin{align}
    \mathrm{E}_r \big[ s_{n} s_{n'} \big]
     & =
    \resizebox{1.5\hsize}{!}{$
            \begin{dcases}
                \dfrac{\Gamma(\alpha + \beta)}{\Gamma(\alpha)\Gamma(\beta)}
                \int\limits_0^1
                \left(
                1 - \dfrac{(1-b) (c_0 + c_1 r)}{2 (1 + c_0 + c_1 r)}
                \right)^2
                \\
                \qquad\qquad\quad\quad\quad\quad\quad
                \times
                \,\,
                r^{\alpha - 1}
                (1 - r)^{\beta - 1}
                \mathrm{d} r
                 &
                \qquad
                \parbox[t]{\linewidth}{\vspace{-2.5em}$l = l' = 0, \\m = m' = 0$}
                \\[2em]
                %
                %
                %
                -\dfrac{\Gamma(\alpha + \beta)}{\Gamma(\alpha)\Gamma(\beta)}
                \int\limits_0^1
                \left(
                1 - \dfrac{(1-b) (c_0 + c_1 r)}{2 (1 + c_0 + c_1 r)}
                \right)
                \\
                \qquad\qquad\quad\quad\quad\quad\quad\quad\quad\quad\quad
                \times
                %
                \left(
                \dfrac{(1-b) (c_0 + c_1 r) \left( 2 + c_0 + c_1 r \right)}
                    {2 \sqrt{2l + 1} (1 + c_0 + c_1 r)^{l + 1}}
                \right)
                %
                \\[0.75em]
                \qquad\qquad\quad\quad\quad\quad\quad\quad\quad\quad\quad
                \times
                \,\,
                r^{\alpha - 1}
                (1 - r)^{\beta - 1}
                \mathrm{d} r
                 &
                \qquad
                \parbox[t]{\linewidth}{\vspace{-5em}$l > 0,        \\l' = 0, \\m = m' = 0$}
                \\[2em]
                %
                %
                %
                -\dfrac{\Gamma(\alpha + \beta)}{\Gamma(\alpha)\Gamma(\beta)}
                \int\limits_0^1
                \left(
                \dfrac{(1-b) (c_0 + c_1 r) \left( 2 + c_0 + c_1 r \right)}
                    {2 \sqrt{2l + 1} (1 + c_0 + c_1 r)^{l + 1}}
                \right)
                \\
                \qquad\qquad\quad\quad\quad\quad\quad\quad\quad\quad\quad
                \times
                %
                \left(
                \dfrac{(1-b) (c_0 + c_1 r) \left( 2 + c_0 + c_1 r \right)}
                    {2 \sqrt{2l' + 1} (1 + c_0 + c_1 r)^{l' + 1}}
                \right)
                %
                \\[0.75em]
                \qquad\qquad\quad\quad\quad\quad\quad\quad\quad\quad\quad
                \times
                \,\,
                r^{\alpha - 1}
                (1 - r)^{\beta - 1}
                \mathrm{d} r
                 &
                \qquad
                \parbox[t]{\linewidth}{\vspace{-5em}$l > 0,        \\l' > 0, \\m = m' = 0$}
                \\[2em]
                %
                %
                %
                0
                 &
                \qquad m, m' \ne 0
                \quad,
            \end{dcases}
        $}
    \raisetag{14.5em}
\end{align}
%
where $l' = l'(n')$ and $m' = m'(n')$ are again given by Equation~(\ref{eq:lm})
and, by symmetry, the expression for $l' > 0, \, l = 0, \, m = m' = 0$ is the same as
in the second case, provided we make the substitution $l \rightarrow l'$.
%
These integrals again reduce to closed form expressions:
%
\vspace{1in}
%
\begin{align}
    \mathrm{E}_r \big[ s_{n} s_{n'} \big]
     & =
    \resizebox{1.4\hsize}{!}{$
            \begin{dcases}
                1 + \dfrac{1-b}{1+c_0}
                \bigg[
                    -c_0 H_0^0
                    -
                    c_1 H_0^1
                    \\[0.75em]
                \qquad\qquad\enspace\enspace\quad\quad
                +
                \dfrac{1-b}{2(1+c_0)}
                \bigg(
                \dfrac{c_0^2}{2}H_1^0
                +
                c_0 c_1 H_1^1
                +
                \dfrac{c_1^2}{2} H_1^2
                \bigg)
                \bigg]
                 &
                \qquad
                \parbox[t]{\linewidth}{\vspace{-3.5em}$l = l' = 0, \\m = m' = 0$}
                \\[2em]
                %
                %
                %
                \dfrac{1-b}{2\sqrt{2l + 1}(1+c_0)^{l+1}}
                \\[0.75em]
                \enspace\quad
                \times
                \bigg[
                    c_0(2 + c_0) H_l^0 + 2 c_1(1 + c_0) H_l^1
                    + c_1^2 H_l^2
                    \\[0.75em]
                \qquad
                - \dfrac{1 - b}{2(1 + c_0)} \bigg(
                c_0^2(2 + c_0) H_{l+1}^0
                + c_0 c_1 (4 + 3 c_0) H_{l+1}^1
                \\[0.75em]
                \qquad
                + (2 + 3 c_0) c_1^2 H_{l + 1}^2
                + c_1^3 H_{l + 1}^3
                \bigg)
                \bigg]
                 &
                \qquad
                \parbox[t]{\linewidth}{\vspace{-7em}$l > 0,        \\l' = 0, \\m = m' = 0$}
                \\[2em]
                %
                %
                %
                \dfrac{(1 - b)^2}{4\sqrt{(2l + 1)(2l' + 1)}(1+c_0)^{l+l'+2}}
                \\[0.75em]
                \enspace\quad
                \times
                \bigg[
                    c_0^2(2+c_0)^2 H_{l + l' + 1}^0
                    + 4 c_0 (1 + c_0) (2 + c_0) c_1 H_{l + l' + 1}^1
                    \\[0.75em]
                \qquad
                + 2 \big(2 + 3 c_0 (2 + c_0)\big)c_1^2 H_{l + l' + 1}^2
                + 4(1 + c_0)c_1^3 H_{l + l' + 1}^3
                \\[0.75em]
                \qquad
                + c_1^4 H_{l + l' + 1}^4
                \bigg]
                 &
                \qquad
                \parbox[t]{\linewidth}{\vspace{-6em}$l > 0,        \\l' > 0, \\m = m' = 0$}
                \\[2em]
                %
                %
                %
                0
                 &
                \qquad m, m' \ne 0
                \quad.
            \end{dcases}
        $}
    \raisetag{16.5em}
\end{align}
%

\clearpage

%
\noindent The final step is to evaluate the integral in Equation~(\ref{eq:Er2}), given
the PDF in Equation~(\ref{eq:lognormal}):
%
\begin{align}
    \mathrm{E} \big[ s_{n} s_{n'} \big]
     & =
    \resizebox{1.4\hsize}{!}{$
            \begin{dcases}
                1 + \dfrac{\gamma_1}{1+c_0}
                \bigg[
                    -c_0 H_0^0
                    -
                    c_1 H_0^1
                    \\[0.75em]
                \qquad\qquad\enspace\enspace\quad\quad
                +
                \dfrac{\gamma_2}{2\gamma_1(1+c_0)}
                \bigg(
                \dfrac{c_0^2}{2}H_1^0
                +
                c_0 c_1 H_1^1
                +
                \dfrac{c_1^2}{2} H_1^2
                \bigg)
                \bigg]
                 &
                \qquad
                \parbox[t]{\linewidth}{\vspace{-3.5em}$l = l' = 0, \\m = m' = 0$}
                \\[2em]
                %
                %
                %
                \dfrac{\gamma_1}{2\sqrt{2l + 1}(1+c_0)^{l+1}}
                \\[0.75em]
                \enspace\quad
                \times
                \bigg[
                    c_0(2 + c_0) H_l^0 + 2 c_1(1 + c_0) H_l^1
                    + c_1^2 H_l^2
                    \\[0.75em]
                \qquad
                - \dfrac{\gamma_2}{2\gamma_1(1 + c_0)} \bigg(
                c_0^2(2 + c_0) H_{l+1}^0
                + c_0 c_1 (4 + 3 c_0) H_{l+1}^1
                \\[0.75em]
                \qquad
                + (2 + 3 c_0) c_1^2 H_{l + 1}^2
                + c_1^3 H_{l + 1}^3
                \bigg)
                \bigg]
                 &
                \qquad
                \parbox[t]{\linewidth}{\vspace{-7em}$l > 0,        \\l' = 0, \\m = m' = 0$}
                \\[2em]
                %
                %
                %
                \dfrac{\gamma_2}{4\sqrt{(2l + 1)(2l' + 1)}(1+c_0)^{l+l'+2}}
                \\[0.75em]
                \enspace\quad
                \times
                \bigg[
                    c_0^2(2+c_0)^2 H_{l + l' + 1}^0
                    + 4 c_0 (1 + c_0) (2 + c_0) c_1 H_{l + l' + 1}^1
                    \\[0.75em]
                \qquad
                + 2 \big(2 + 3 c_0 (2 + c_0)\big)c_1^2 H_{l + l' + 1}^2
                + 4(1 + c_0)c_1^3 H_{l + l' + 1}^3
                \\[0.75em]
                \qquad
                + c_1^4 H_{l + l' + 1}^4
                \bigg]
                 &
                \qquad
                \parbox[t]{\linewidth}{\vspace{-6em}$l > 0,        \\l' > 0, \\m = m' = 0$}
                \\[2em]
                %
                %
                %
                0
                 &
                \qquad m, m' \ne 0
                \quad.
            \end{dcases}
        $}
    \raisetag{16.5em}
\end{align}
%
where we define
%
\begin{align}
    \gamma_2 \equiv 1
    - 2\exp\bigg[ \mu + \frac{1}{2}\nu\bigg]
    + \exp\bigg[ 2\mu + 2\nu\bigg]
    \quad,
\end{align}
%
and the expression for $l' > 0, \, l = 0, \, m = m' = 0$ is again the same as in
the second case, provided we make the substitution $l \rightarrow l'$.

\bibliography{bib}

\end{document}